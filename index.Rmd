---
output: html_document
editor_options: 
  chunk_output_type: console
---
---
title: "Title"
output:
  html_document:
    toc: true
    toc_float: true
    highlight: "zenburn"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
library(vegan)
library(lsmeans)
library(glmmTMB)
library(cowplot)
library(boot)
source("Scripts/functions.R")
```

# Disentangling the drivers and trade-offs of pollinator-mediated interactions between the foundation shrub Creosote bush (Larrea tridentata) and the annual desert dandelion (Malacothrix glabrata)  

\newline

***

\newline


## Overview
In arid ecosystems shrub facilitation is a critical process driving plant community structure and assembly, which leads to concentrations of annuals beneath the shrub canopies. Pollinator-mediated interactions have fitness consequences for their participants but are a largely unexplored indirect consequence of shrub-annual facilitation. We tested the capacity of the geographically widespread Creosote bush Larrea tridentata to influence the pollination of its annual understory during its phenological shift into spring flowering. In this system, we found that L. tridentata had a positive ecological effect on annual plant cover, as well as the abundance and richness of the arthropod community but that it also had indirect negative effects on pollinator visitation to a representative flowering annual plant which intensified when L. tridentata bloomed. These finding suggest that the net outcome of association with foundation plant species can be positive or negative depending on both the life-history stage of the protégé species tested and on the phenology of the foundation species. There is the capacity for these trade-offs to be widespread and an increasing focus on further documenting these trade-offs will advance both facilitation theory and assessment of selection processes that can drive co-evolutionary relationships between shrubs, annual plants, and pollinators.  

\newline

***

\newline

```{r, graphic, echo= FALSE}
knitr::include_graphics('./Images/site.jpg')
```



***
#Statistics and modelling

## Pollinator visitation

### Visitation modelling
Hypothesis testing for visitation. GLMM are computationally difficult so workflow is: Base hypothesis model to test for additive vs. interactive effects of predictors. Then add each covariate the best base model. RTU specific responses require a different dataframe so those analyses are done separately. Very full models are not tractable. AllFit.R started throwing an error so moving from lme4 to glmmTMBB. Support for car::Anova in glmmTMB is in the development version.

```{r, visitation models}
byrep <- read.csv("Output Data/byrep_cleaned.csv")
byrep$repID <- paste(byrep$PlantID, byrep$treatment)
byrep$treatment <- relevel(byrep$treatment, "open")
byrep$flowering <- relevel(byrep$flowering, "pre")

count(byrep, Date)
dates <- read.csv("Clean Data/dates.csv")
dates$Dates <- gsub('\\s+', "", dates$Dates)


dates$Date <- dates$Dates
byrep <- left_join(byrep, dates, by = "Date")



#calculate mean video length
mean(byrep$dec.Length)

#calculate total flower visits and total foraging instances
sum(byrep$total.flowers)
sum(byrep$total.visits)

#should be 925 and 697 - not 930 and 701.

pt <- byrep %>% filter(.,flowering == "pre" & treatment == "shrub") 
f <- pt %>% filter(flowers.shrub > 0)
f <- pt$flowers.shrub
sd(pt$flowers.shrub, na.rm = TRUE)

```
Flower visits
```{r, visitation models base}
#base hypothesis testing model
#additive
m1 <- glmmTMB(total.flowers ~ treatment + flowering + flowers.pot +  offset(log(dec.Length)) + (1|PlantID/repID), family = "nbinom2", data = byrep)
summary(m1)
car::Anova(m1, type = 2)

#interactive model

m2 <- glmmTMB(total.flowers ~ treatment * flowering + flowers.pot + offset(log(dec.Length)) + (1|PlantID/repID),  family = "nbinom2", data = byrep)
summary(m2)
car::Anova(m2, type =3)

null <- glmmTMB(total.flowers ~ flowers.pot + offset(log(dec.Length)) + (1|PlantID/repID),  family = "nbinom2", data = byrep)
summary(null)

anova(null, m1,m2)
AIC(m1,m2, null)
car::Anova(m2, type = 3)

#model 1 is best fit
```

Foraging bouts
```{r, visitation models (foraging)}
#base additive model foraging instances
m3 <- glmmTMB(total.visits ~ treatment + flowering + flowers.pot + offset(log(dec.Length)) + (1|PlantID/repID), family = "nbinom2", data = byrep)
summary(m3)
car::Anova(m3, type = 2)


#base interactive model
m5 <- glmmTMB(total.visits ~ treatment * flowering + flowers.pot + offset(log(dec.Length)) + (1|PlantID/repID), family = "nbinom2", data = byrep)
summary(m5)
car::Anova(m5, type = 3)


#null model
null <- glmmTMB(total.visits ~ flowers.pot + offset(log(dec.Length)) + (1|PlantID/repID), family = "nbinom2", data = byrep)


anova(null, m3,m5)
AIC(m3, m5, null)

ggplot(byrep, aes(flowering, flowers.per.hour)) + geom_boxplot() + facet_grid(~treatment)

```
###Testing importance of covariates
using TMB because glmer will not coverge.

Annual floral density
```{r}
c2 <- glmmTMB(total.visits ~ treatment * flowering + flowers.pot + het.annual.floral.density + het.shrub.blooming.neighbours + offset(log(dec.Length)) + (1|PlantID/repID), family = nbinom2(link = "log"), data = byrep)
summary(c2)
car::Anova(c2, type = 3)

c2.v <- glmmTMB(total.visits ~ treatment + flowering + het.annual.floral.density + flowers.pot + offset(log(dec.Length)) + (1|PlantID/repID), family = nbinom2(link = "log"), data = byrep)
summary(c2.v)
car::Anova(c2.v, type = 2)

q <- glmmTMB(total.visits ~ treatment + flowering + flowers.pot + het.annual.floral.density + offset(log(dec.Length)) + (1|PlantID/repID), family = nbinom1(link = "log"), data = byrep)
car::Anova(q, type = 2)
AIC(c2.v, q)

#nbinom2 better

#flowers
c2.f <- glmmTMB(total.flowers ~ treatment * flowering + het.annual.floral.density + flowers.pot + offset(log(dec.Length)) + (1|PlantID/repID), family = nbinom2(link = "log"), data = byrep)
summary(c2.f)
car::Anova(c2.f, type = 3)

c2.flowers <- glmmTMB(total.flowers ~ treatment + flowering + flowers.pot + het.annual.floral.density + offset(log(dec.Length)) + (1|PlantID/repID), family = nbinom2(link = "log"), data = byrep)
summary(c2.flowers)
car::Anova(c2.flowers, type = 2)
```
Number of blooming shrub neighbours
```{r}
c3 <- glmmTMB(total.flowers ~ treatment + flowering + flowers.pot + het.shrub.blooming.neighbours + offset(log(dec.Length)) + (1|PlantID/repID), family = "nbinom2", data = byrep)
summary(c3)
car::Anova(c3, type = 2)

c2.v <- glmmTMB(total.visits ~ treatment + flowering + flowers.pot + het.shrub.blooming.neighbours + offset(log(dec.Length)) + (1|PlantID/repID), family = "nbinom2", data = byrep)
summary(c2.v)
car::Anova(c2.v)




#each model with both covariates added
c.visits <- glmmTMB(total.visits ~ treatment + flowering + flowers.pot + het.annual.floral.density + het.shrub.blooming.neighbours +  offset(log(dec.Length)) + (1|PlantID/repID), family = "nbinom2", data = byrep)
summary(c.visits)
car::Anova(c.visits, type = 2)


c.flowers <- glmmTMB(total.flowers ~ treatment * flowering + flowers.pot + het.annual.floral.density + het.shrub.blooming.neighbours +  offset(log(dec.Length)) + (1|PlantID/repID), family = "nbinom2", data = byrep)
summary(c.flowers)
t <- car::Anova(c.flowers, type = 2)
```
### Number of larrea flowers

```{r, blooms as numeric}
shr <- byrep %>% filter(treatment == "shrub")

s1 <- glmmTMB(total.flowers ~ flowers.shrub*flowering + flowers.pot + het.annual.floral.density  +  offset(log(dec.Length)) + (1|PlantID), family = "nbinom2", data = shr)
summary(s1)
kable(car::Anova(s1, type = 3))

#library(performance)
#check_overdispersion(s1)
library(emmeans)

l <- emtrends(s1,  pairwise ~ flowering, var = "flowers.shrub")
l
s2 <- glmmTMB(total.visits ~ flowers.shrub*flowering + flowers.pot + het.annual.floral.density  +  offset(log(dec.Length)) + (1|PlantID), family = "nbinom2", data = shr)
summary(s2)
kable(car::Anova(s2, type = 3))
```
### RTU visitation modelling
Models for testing RTU-specificity
```{r, rtu specificity}
byrtu <- read.csv("Output Data/rtu_by_rep.csv")
byrtu$repID <- paste(byrtu$PlantID, byrtu$treatment)
byrtu$treatment <- relevel(byrtu$treatment, "open")
byrtu$flowering <- relevel(byrtu$flowering, "pre")

#Full model (foraging instances)
mFullPQ <- MASS::glmmPQL(total.visits~flowering * rtu * treatment + flowers.pot + het.annual.floral.density + het.shrub.blooming.neighbours + offset(log(dec.Length)), random = ~1|PlantID/repID, family="quasipoisson", data = byrtu)
summary(mFullPQ)
t <- car::Anova(mFullPQ, type = 3)

mP1 <- MASS::glmmPQL(total.visits~flowering * rtu + treatment + flowers.pot + het.annual.floral.density + het.shrub.blooming.neighbours + offset(log(dec.Length)), random = ~1|PlantID/repID, family="quasipoisson", data = byrtu)
car::Anova(mP1, type = 3)


mPt <- MASS::glmmPQL(total.visits~ flowering * rtu +  treatment + flowers.pot + het.annual.floral.density + offset(log(dec.Length)), random = ~1|PlantID/repID, family="quasipoisson", data = byrtu)
summary(mPt)
car::Anova(mPt, type = 3)
lsmeans(mPt, pairwise~flowering|rtu)


#full model flower visits
mFullPQv <- MASS::glmmPQL(total.flowers~flowering * rtu * treatment + flowers.pot + het.annual.floral.density + het.shrub.blooming.neighbours + offset(log(dec.Length)), random = ~1|PlantID/repID, family="quasipoisson", data = byrtu)
summary(mFullPQv)
t <- car::Anova(mFullPQv, type = 3)

m <- MASS::glmmPQL(total.flowers~flowering * rtu + treatment*flowering + flowers.pot +offset(log(dec.Length)), random = ~1|PlantID/repID, family="quasipoisson", data = byrtu)
car::Anova(m, type = 3)

mQ <- MASS::glmmPQL(total.flowers~flowering * rtu + treatment + flowers.pot + offset(log(dec.Length)), random = ~1|PlantID/repID, family="quasipoisson", data = byrtu)
summary(mQ)
lsmeans(mQ, pairwise~flowering|rtu, adjust = "Tukey")
car::Anova(mQ, type = 3)


mQt <- MASS::glmmPQL(total.flowers~treatment * rtu + flowering + flowers.pot + offset(log(dec.Length)), random = ~1|PlantID/repID, family="quasipoisson", data = byrtu)
summary(mQt)

#RTU by microsite not significant
```



### Visit duration 
```{r, duration models}
byobs <- read.csv("Output Data/byobs_cleaned.csv")

#observation level rtu data. Need to join simplified rtu to data sheet
cov <- read.csv("Clean Data/video_cov.csv")
#rtu.key <- read.csv("Clean Data/video_rtu_key.csv")
cov$uniID <- paste(cov$Cam, cov$Date)
cov$uniID <- gsub('\\s+', "", cov$uniID)

rtu.data <- right_join(cov, byobs, by = "uniID")
rtu.data <- dplyr::select(rtu.data, plant.id, microsite, flowering.x, video.date, video.length, flower.fov, flowers.pot, flowers.shrub, total.time, flowers.visits, unique.fl.visited, uniID, dec.total.time, het.annual.floral.density)                    
rtu.data$repID <- paste(rtu.data$plant.id, rtu.data$microsite)
rtu.data$microsite <-as.factor(rtu.data$microsite)
rtu.data$microsite <- relevel(rtu.data$microsite, "open")
rtu.data$flowering <- relevel(rtu.data$flowering, "pre")
rtu.data$flowers.pot <- as.numeric(as.character(rtu.data$flowers.pot))
#count.rtu.fl <- rtu.data %>% group_by(uniID, rtu.ag) %>% summarise(total.flowers = sum(flowers.visits), total.visits = n()) 

#viz. dec.total.time is the visit duration
ggplot(rtu.data, aes(microsite, dec.total.time)) + geom_boxplot() + facet_grid(~flowering)
ggplot(rtu.data, aes(flowering, dec.total.time)) + geom_boxplot() + facet_grid(~microsite)
ggplot(rtu.data, aes(dec.total.time)) + geom_density()

#using gamma because continuous and positive with no zeros, looks like it fits 

m1 <- glmmTMB(dec.total.time ~ flowering + microsite + flowers.pot + (1|plant.id/repID), family = Gamma(link = "log"), data = rtu.data)
m2 <- glmmTMB(dec.total.time ~ flowering * microsite + flowers.pot + (1|plant.id/repID), family = Gamma(link = "log"), data = rtu.data)

null <- glmmTMB(dec.total.time ~(1|plant.id/repID), family = Gamma(link = "log"), data = rtu.data)
anova(m1, m2, null)

summary(m2)
knitr::kable(car::Anova(m2, type =2))

#with covariates
m3 <- glmmTMB(dec.total.time ~ flowering + microsite + flowers.pot + het.annual.floral.density + (1|plant.id/repID), family = Gamma(link = "log"), data = rtu.data)
summary(m3)
car::Anova(m3, type = 2)

shr.rtu <- filter(rtu.data, microsite == "shrub")
m4 <- glmmTMB(dec.total.time ~ flowering*flowers.shrub + flowers.pot + het.annual.floral.density + (1|plant.id), family = Gamma(link = "log"), data = shr.rtu)
summary(m4)
kable(car::Anova(m4, type = 3))
```

### Pollen Deposition

```{r, pollen deposition}
counts <- read.csv("Clean Data/Pollen_Corrected.csv")
cov <- read.csv("Clean Data/pollen_cov.csv")
counts$X <- as.numeric(as.character(counts$X))   
counts <- counts %>% replace(is.na(.), 0)
counts <- counts %>% mutate(all.con = rowSums(.[5:18]))
counts <- select(counts, Rep:Het.Grains, all.con)                
counts.ag <- counts %>% group_by(Rep, Slide) %>% summarise(Het = sum(Het.Grains), Con = sum(all.con))             
counts.ag <- counts.ag %>% mutate(., microsite = ifelse(substr(Rep,start = 1, stop = 1) == "S", "shrub", "open"))
counts.ag$Flower <- substr(counts.ag$Slide, 1, 1)

sum(counts.ag$Con)
sum(counts.ag$Het)

counts.ag <- right_join(counts.ag, cov, by = "Rep")

#ag by flower
count.fl <- counts.ag %>% group_by(., Flower) %>% summarise(con = sum(Con))
count.fl$f2 <- count.fl$Flower

count.fl <- count.fl %>%
  separate(Flower, c("Rep", "no"), " ")
counts.fl <- right_join(count.fl, cov, by = "Rep")


#m1 <- MASS::glmmPQL(con~ d.flowers + microsite + dN1, ~1|Rep, family = quasipoisson, data = counts.fl)
#summary(m1)

ggplot(data =counts.ag,(aes(microsite.x, Con))) + geom_boxplot()
ggplot(data =counts.ag,(aes(microsite.x, Het))) + geom_boxplot()


ggplot(data = counts.ag, (aes(Con))) + geom_freqpoly()
shapiro.test(counts.ag$Con)

counts.ag$Flower <- paste(counts.ag$Rep, counts.ag$Flower)
counts.ag$Sample <- paste(counts.ag$Slide, counts.ag$Rep)
counts.ag$d.S <- counts.ag$d.S %>% replace(is.na(.), 0)
counts.ag <- counts.ag %>% mutate(., all = Con + Het)
cor.test(counts.ag$Con, counts.ag$Het)

mean(counts.ag$d.S)
mean(counts.ag$dN1)
mean(counts.ag$d.flowers)

m1 <- glmmTMB(Con ~ d.flowers + dN1 + d.S + (1|Shrub/Rep/Flower), family = "nbinom2", data = counts.ag)
summary(m1)
kable(car::Anova(m1, type = 2))


null <- glmmTMB(Con ~ (1|Shrub/Rep/Flower), family = "nbinom2", data = counts.ag)
summary(null)

AIC(m1, null)
anova(m1, null)

m4 <- glmmTMB(Het ~ d.flowers + dN1 + d.S + (1|Shrub/Rep/Flower), family = "nbinom2", data = counts.ag)
summary(m4)
kable(car::Anova(m4, type = 2))


null <- glmmTMB(Het ~ (1|Shrub/Rep/Flower), family = "nbinom2", data = counts.ag)

AIC(m4, null)
anova(m4, null)
```

```{r, pollen plots, warning=F}
p3 <- ggplot(counts.ag, aes(d.S, Con)) + geom_point(shape = 1) + geom_smooth(colour = "black", size = 0.5) + geom_jitter(shape = 1) + theme_Publication() + xlab("Distance to Larrea tridentata") + ylab("Conspecific Pollen Deposition")


p4 <- ggplot(counts.ag, aes(d.S, Het)) + geom_point(shape = 1) + geom_smooth(colour = "black", size = 0.5) + geom_jitter(shape = 1) + theme_Publication() + xlab("Distance to Larrea tridentata") + ylab("Heterospecific Pollen Deposition")

p3
p4
```



***
## Community level effects

***

### Vegetation Modelling
GLMM for vegetation covariates to test for direct shrub facilitation/background flowering levels

***
Annual Percent Cover
```{r, percent cover}

visits <- read.csv("Output Data/byrep_cleaned.csv")
metadata <- read.csv("Output Data/metadata_nobeetle.csv")

#only care about the veg
visits <- dplyr::select(visits, uniID, treatment, flowering, het.shrub.blooming.neighbours, het.cactus.blooming.neighbours, understory.richness, het.annual.floral.density, PlantID)
visits$flowering <- relevel(visits$flowering, "pre")
metadata$blooming <- relevel(metadata$blooming, "pre")

metadata <- dplyr::select(metadata, uniID, plant.id, treatment, blooming, percent.cover, date)
metadata$repID <- paste(metadata$plant.id, metadata$treatment)
visits$repID <- paste(visits$PlantID, visits$treatment)


#percent.cover
shapiro.test(metadata$percent.cover)
mean(metadata$percent.cover)
sd(metadata$percent.cover)
ggplot(metadata, aes(percent.cover)) + geom_density()


#updating to binomial model because of proportion
metadata$steps <- 100
y <- cbind(metadata$percent.cover, metadata$steps)

g1.b <- glmmTMB(y ~ treatment + blooming + (1|plant.id/repID), family = "binomial", data = metadata)
g1.b1 <- glmmTMB(y ~ treatment * blooming + (1|plant.id/repID), family = "binomial", data = metadata)

g1.b.null <- glmmTMB(y ~ 1 + (1|plant.id/repID), family = "binomial", data = metadata)


AIC(g1.b, g1.b1, g1.b.null)

anova(g1.b, g1.b1, g1.b.null)

summary(g1.b1)
car::Anova(g1.b1, type = 3)



#posthoc in interaction
ph <- lsmeans(g1.b1, pairwise~treatment*blooming, adjust="tukey")
summary(ph)

ggplot(metadata, aes(treatment, percent.cover)) + geom_boxplot() + facet_grid(~blooming)

ggplot(metadata, aes(treatment, percent.cover)) + geom_boxplot() + theme_Publication() + ylab("Percent Annual Vegetation Cover") + xlab("Microsite")
ggplot(metadata, aes(treatment, percent.cover)) + geom_boxplot() + theme_Publication() + ylab("Percent Annual Vegetation Cover") + xlab("Microsite") + facet_grid(~blooming,labeller=labeller(blooming = labels))
```

***
Annual Richness

```{r, annual richness}
mean(visits$understory.richness, na.rm = TRUE)
sd(visits$understory.richness, na.rm = TRUE)

shapiro.test(visits$understory.richness)
ggplot(visits, aes(understory.richness)) + geom_density()


g2 <- glmmTMB(understory.richness ~ treatment + flowering + (1|PlantID/repID), family = poisson(link="log"), data = visits)
g2.2 <- glmmTMB(understory.richness ~ treatment * flowering + (1|PlantID/repID), family = poisson(link="log"), data = visits)
g2.null <- glmmTMB(understory.richness ~ 1 + (1|PlantID/repID), family = poisson(link="log"), data = visits)
g2b <- glmmTMB(understory.richness ~ treatment + flowering + (1|PlantID/repID), family = nbinom2, data = visits)


summary(g2)
summary(g2.2)
summary(g2.null)

anova(g2, g2.null, g2.2, g2b, test = "Chisq")
AIC(g2, g2.2, g2.null, g2b)
car::Anova(g2, type = 2)


#null model is the best fit


ggplot(visits, aes(treatment, understory.richness)) + geom_boxplot() + facet_grid(~flowering, labeller=labeller(flowering = labels)) + theme_Publication() + xlab("Microsite") + ylab("Annual Species Richness")
```

***
Annual Floral Density
number of all blooms in quadrat

```{r, annual floral density}
mean(visits$het.annual.floral.density, na.rm = TRUE)
sd(visits$het.annual.floral.density, na.rm = TRUE)

ggplot(visits, aes(het.annual.floral.density)) + geom_density()

g3.nb <- glmmTMB(het.annual.floral.density ~ flowering * treatment + (1|PlantID/repID), family = "nbinom2", data = visits)

g3.nb.1 <- glmmTMB(het.annual.floral.density ~ flowering + treatment + (1|PlantID/repID), family = "nbinom2", data = visits)

g3.nb.null <- glmmTMB(het.annual.floral.density ~ 1 + (1|PlantID/repID), family = "nbinom2", data = visits)

g3.p <- glmmTMB(het.annual.floral.density ~ 1 + (1|PlantID/repID), family = "poisson", data = visits)

g3.nb.type1 <- glmmTMB(het.annual.floral.density ~ 1 + (1|PlantID/repID), family = "nbinom1", data = visits) 

summary(g3.nb)
summary(g3.nb.1)
summary(g3.nb.null)
anova(g3.nb, g3.nb.null, g3.nb.1, g3.p, g3.nb.type1, test = "Chisq")

car::Anova(g3.nb.1, type = 2)
AIC(g3.nb, g3.nb.1, g3.p, g3.nb.type1, g3.nb.null)
#negative binomial type 2, additive model

ggplot(visits, aes(treatment, het.annual.floral.density)) + geom_boxplot() + facet_grid(~flowering, labeller=labeller(flowering = labels)) + theme_Publication() + xlab("Microsite") + ylab("Heterospecific Annual Floral Density")

```

***
Blooming shrub density

```{r, shrub density}
mean(visits$het.shrub.blooming.neighbours, na.rm = TRUE)
sd(visits$het.shrub.blooming.neighbours, na.rm = TRUE)

ggplot(visits, aes(het.shrub.blooming.neighbours)) + geom_density(kernel = "gaussian")

g4.nb <- glmmTMB(het.shrub.blooming.neighbours ~ flowering * treatment + (1|PlantID/repID), family = "nbinom2", data = visits)

g4.nb.1 <- glmmTMB(het.shrub.blooming.neighbours ~ flowering + treatment + (1|PlantID/repID), family = "nbinom2",data = visits)

g4.nb.null <- glmmTMB(het.shrub.blooming.neighbours ~ 1 + (1|PlantID/repID), family = "nbinom2",data = visits)
summary(g4.nb)
summary(g4.nb.1)
summary(g4.nb.null)
anova(g4.nb, g4.nb.null, g4.nb.1, test = "Chisq")
car::Anova(g4.nb.1, type = 2)
AIC(g4.nb, g4.nb.1, g4.nb.null)

ggplot(visits, aes(treatment, het.shrub.blooming.neighbours)) + geom_boxplot() + theme_Publication() + ylab("Blooming Shrubs within 2 m") + xlab("Microsite")   
ggplot(visits, aes(treatment, het.shrub.blooming.neighbours)) + geom_boxplot() + theme_Publication() + ylab("Blooming Shrubs within 2 m") + xlab("Microsite") + facet_grid(~flowering,labeller=labeller(flowering = labels)) 

```

***
Blooming cactus density

```{r, cactus density}
mean(visits$het.cactus.blooming.neighbours, na.rm = TRUE)
sd(visits$het.cactus.blooming.neighbours, na.rm = TRUE)

ggplot(visits, aes(het.cactus.blooming.neighbours)) + geom_density(kernel = "gaussian")

g5.nb <- glmmTMB(het.cactus.blooming.neighbours ~ flowering * treatment + (1|PlantID/repID), family = "nbinom2", data = visits)


g5.ps <- glmmTMB(het.cactus.blooming.neighbours ~ flowering * treatment + (1|PlantID/repID), family = poisson(link = "log"), data = visits)
g5.ps.1 <- glmmTMB(het.cactus.blooming.neighbours ~ flowering + treatment + (1|PlantID/repID), family = poisson(link = "log"), data = visits)
g5.ps.null <- glmmTMB(het.cactus.blooming.neighbours ~ 1 + (1|PlantID/repID), family = poisson(link ="log"), data = visits)


summary(g5.ps)
summary(g5.ps.1)
summary(g5.ps.null)
anova(g5.nb, g5.ps, g5.ps.null, g5.ps.1, test = "Chisq")
car::Anova(g5.ps.1, type = 2)
AIC(g5.nb, g5.ps, g5.ps.1, g5.ps.null)

#poisson additive is best


ggplot(visits, aes(treatment, het.cactus.blooming.neighbours)) + geom_boxplot() + facet_grid(~flowering, labeller=labeller(flowering = labels)) + theme_Publication() + xlab("Microsite") + ylab("Blooming Cactus Density within 2m")

```

***

### Pan traps

These are models for abundance, species richness, bee abundance and bee richness from pan traps.

***


### Pan trap diversity calculations
This sections calculates diversity indices and exports full env/metadata .csv 

Calculations excluding Melyrid beetles
```{r, diversity calculations}

insects <- read.csv("Output Data/pantraps_wide.csv", header = TRUE)
row.names(insects) <- insects$uniID
insects <- dplyr::select(insects, -X, -uniID)

#filter out Melyrid beetles
insects <- dplyr::select(insects, -Melyridae)
metadata <- read.csv("Clean Data/pantraps_cov.csv", header = TRUE)
metadata <- filter(metadata, species != "buckhorn")
metadata$plant.id <- as.character(metadata$plant.id)
str(metadata)
metadata$uniID <- paste(metadata$date, metadata$plant.id, metadata$treatment)
row.names(metadata) <- metadata$uniID


#check all ids in datasheets are found in the other
#zero.row <- anti_join(metadata, insects, by = "uniID")
#missing <- anti_join(insects, metadata, by = "uniID")
#write.csv(zero.row, "zeroreps.csv")

#check if insects and metadata are the same
all.equal(rownames(insects), rownames(metadata))
#sort into the same order
metadata <- metadata[rownames(insects), ]
#confirm - woo!
all.equal(rownames(insects), rownames(metadata))

#grab and wrangle weather stn data
weather <- read.csv("Clean Data/pantraps_weather.csv")
str(weather)

weather.av <- weather %>% group_by(., date) %>% summarise(., mean.Solar = mean(Solar), mean.Wind = mean(Wind), mean.MaxWind = mean(Max), mean.Temp = mean(Air.Temperature))
metadata <- right_join(weather.av, metadata, by = "date")

#calculate abundances using vegan
metadata$abun <- apply(insects, 1, sum)
#check for total
sum(metadata$abun)
H <- diversity(insects)
simp <- diversity(insects, "simpson")
S <- specnumber(insects)
J <- H/log(S)
metadata$H <- H
metadata$Simpson <- simp
metadata$Species <- S
metadata$Even <- J

summary(metadata)

#no Melyrid beetle output
write.csv(metadata, "Output Data/metadata_nobeetle.csv")
write.csv(insects, "Output Data/wide_nobeetle.csv")
```
Calculations including Melyrid beetles
```{r, div calculations including melyrids}
#with beetles
insects <- read.csv("Output Data/pantraps_wide.csv", header = TRUE)
row.names(insects) <- insects$uniID
insects <- dplyr::select(insects, -X, -uniID, -Zeroes)
#filter out beetles
#insects <- dplyr::select(insects, -Melyridae, -Melyridae.)
metadata <- read.csv("Clean Data/pantraps_cov.csv", header = TRUE)
metadata <- filter(metadata, species != "buckhorn")
metadata$plant.id <- as.character(metadata$plant.id)
str(metadata)
metadata$uniID <- paste(metadata$date, metadata$plant.id, metadata$treatment)
row.names(metadata) <- metadata$uniID


#check all ids in datasheets are found in the other
#zero.row <- anti_join(metadata, insects, by = "uniID")
#missing <- anti_join(insects, metadata, by = "uniID")
#write.csv(zero.row, "zeroreps.csv")
#check if insects and metadata are the same
all.equal(rownames(insects), rownames(metadata))
#sort into the same order
metadata <- metadata[rownames(insects), ]
#confirm - woo!
all.equal(rownames(insects), rownames(metadata))

#grab and wrangle weather stn data
weather <- read.csv("Clean Data/pantraps_weather.csv")
str(weather)

weather.av <- weather %>% group_by(., date) %>% summarise(., mean.Solar = mean(Solar), mean.Wind = mean(Wind), mean.MaxWind = mean(Max), mean.Temp = mean(Air.Temperature))
metadata <- right_join(weather.av, metadata, by = "date")

metadata$abun <- apply(insects, 1, sum)
#check for total
sum(metadata$abun)
H <- diversity(insects)
simp <- diversity(insects, "simpson")
S <- specnumber(insects)
J <- H/log(S)
metadata$H <- H
metadata$Simpson <- simp
metadata$Species <- S
metadata$Even <- J

summary(metadata)

#beetle output
write.csv(metadata, "Output Data/metadata_yesbeetle.csv")
write.csv(insects, "Output Data/wide_yesbeetle.csv")
```
Calculations for only Melyrid beetles
```{r, div calcs only melyrids}
##beetles only
insects <- read.csv("Output Data/pantraps_wide.csv", header = TRUE)
row.names(insects) <- insects$uniID
insects <- dplyr::select(insects, -X, -uniID)
#filter out beetles
insects <- dplyr::select(insects, Melyridae)
metadata <- read.csv("Clean Data/pantraps_cov.csv", header = TRUE)
metadata <- filter(metadata, species != "buckhorn")
metadata$plant.id <- as.character(metadata$plant.id)
str(metadata)
metadata$uniID <- paste(metadata$date, metadata$plant.id, metadata$treatment)
row.names(metadata) <- metadata$uniID

#check if insects and metadata are the same
all.equal(rownames(insects), rownames(metadata))
#sort into the same order
metadata <- metadata[rownames(insects), ]
#confirm - woo!
all.equal(rownames(insects), rownames(metadata))

#grab and wrangle weather stn data
weather <- read.csv("Clean Data/pantraps_weather.csv")
str(weather)

weather.av <- weather %>% group_by(., date) %>% summarise(., mean.Solar = mean(Solar), mean.Wind = mean(Wind), mean.MaxWind = mean(Max), mean.Temp = mean(Air.Temperature))
metadata <- right_join(weather.av, metadata, by = "date")

metadata$abun <- apply(insects, 1, sum)
#check for total
sum(metadata$abun)
H <- diversity(insects)
simp <- diversity(insects, "simpson")
S <- specnumber(insects)
J <- H/log(S)
metadata$H <- H
metadata$Simpson <- simp
metadata$Species <- S
metadata$Even <- J


summary(metadata)

#no beetle output
write.csv(metadata, "Output Data/metadata_onlybeetle.csv")
write.csv(insects, "Output Data/wide_onlybeetle.csv")
```


Arthropod abundance - Melyridae beetles excluded
```{r, arthropod abundance m excluded}
metadata <- read.csv("Output Data/metadata_nobeetle.csv")
metadata$repID <- paste(metadata$plant.id, metadata$treatment)
metadata$blooming <- relevel(metadata$blooming, "pre")
sum(metadata$abun)
str(metadata)

ggplot(data = metadata, aes(abun)) + geom_freqpoly()
mean(metadata$abun)
sd(metadata$abun)
shapiro.test(metadata$abun)
ggplot(data = metadata, aes(treatment, abun)) + geom_boxplot() + facet_grid(~blooming)

m1 <- glmmTMB(abun ~ treatment * blooming + (1|plant.id/repID), family = "nbinom2", data = metadata)
summary(m1)
#lsmeans(m1, pairwise~blooming*treatment)
car::Anova(m1, type = 3)

m2 <- glmmTMB(abun ~ treatment + blooming + (1|plant.id/repID), family = "nbinom2", data = metadata)
summary(m2)

m3 <- glmmTMB(abun ~ (1|repID), family = "nbinom2", data = metadata)

m4.nb1 <- glmmTMB(abun ~ treatment + blooming + (1|plant.id/repID), family = "nbinom1", data = metadata)

m4.nb1.int <- glmmTMB(abun ~ treatment * blooming + (1|plant.id/repID), family = "nbinom1", data = metadata)

anova(m1, m2, m3, m4.nb1, m4.nb1.int, test = "Chisq")
AIC(m1, m2, m3, m4.nb1, m4.nb1.int)

#looks like nbinom1 (negative binomial type one, additive model)

anova(m4.nb1, m4.nb1.int)
#additive and interactive models are not different - using simpler model

summary(m4.nb1)
car::Anova(m4.nb1, type = 2)
```

***
Including Melyridae beetles
```{r, melyride included}
beetle <- read.csv("Output Data/metadata_yesbeetle.csv")
beetle$repID <- paste(beetle$plant.id, beetle$treatment)
beetle$blooming <- relevel(beetle$blooming, "pre")
sum(beetle$abun)
str(beetle)
sum(beetle$H)

ggplot(data = beetle, aes(abun)) + geom_freqpoly()
mean(beetle$abun)
sd(beetle$abun)

m1 <- glmmTMB(abun ~ blooming + treatment + (1|plant.id/repID), family = "nbinom2", data = beetle)
summary(m1)

m2 <- glmmTMB(abun ~ blooming * treatment + (1|plant.id/repID), family = "nbinom2", data = beetle)
summary(m2)

m3 <- glmmTMB(abun ~  (1|plant.id/repID),family = "nbinom2",  data = beetle)
summary(m3)

m4 <-  glmmTMB(abun ~ blooming + treatment + (1|plant.id/repID), family = "nbinom1", data = beetle)
summary(m4)  
anova(m1, m2, m3, m4)
AIC(m1, m2, m3, m4)

#one and two are pretty much the same, going with simpler, #4 is best (nbinom1)
car::Anova(m4, type = 2)
```


***

Melyridae only
```{r, melyridae abundance only}
onlybeetle <- read.csv("Output Data/metadata_onlybeetle.csv")
onlybeetle$repID <- paste(onlybeetle$plant.id, onlybeetle$treatment)
onlybeetle$blooming <- relevel(onlybeetle$blooming, "pre")
sum(onlybeetle$abun)
str(beetle)

ggplot(data = onlybeetle, aes(abun)) + geom_freqpoly()
mean(onlybeetle$abun)
sd(onlybeetle$abun)

m1 <- glmmTMB(abun ~ blooming * treatment + (1|plant.id/repID), family = "nbinom2", data = onlybeetle)

summary(m1)


m2 <- glmmTMB(abun ~ blooming + treatment + (1|plant.id/repID), family = "nbinom2", data = onlybeetle)

m3 <- glmmTMB(abun ~ (1|plant.id/repID), family = "nbinom2",data = onlybeetle)


AIC(m1, m2, m3)
anova(m1, m2, m3)

summary(m1)
car::Anova(m1, type = 3)
lsmeans(m1, pairwise~blooming*treatment)


ggplot(metadata, aes(blooming, abun)) + geom_boxplot() + facet_grid(~treatment)



```


***
Arthropod Richness
```{r, arthropod richness}

s1 <- glmmTMB(Species ~ blooming + treatment + (1|plant.id/repID), family = poisson, data = beetle)
summary(s1)
s1.nb <- glmmTMB(Species ~ blooming + treatment + (1|plant.id/repID), family = "nbinom1", data = beetle)
summary(s1.nb)
s2 <- glmmTMB(Species ~ blooming * treatment + (1|plant.id/repID), family = poisson, data = beetle)
summary(s2)
s3 <- glmmTMB(Species ~ (1|plant.id/repID), family = poisson, data = beetle)
summary(s3)
AIC(s1, s1.nb, s2, s3)
#poisson best here
anova(s1,s2, s3)
car::Anova(s1, type = 2)

ggplot(beetle, aes(blooming, Species)) + geom_boxplot() + facet_grid(~treatment)
ggplot(beetle, aes(treatment, Species)) + geom_boxplot() + facet_grid(~blooming)

```

```{r, species accumulation}
#species accumulation
insects <- read.csv("Output Data/wide_yesbeetle.csv")
row.names(insects) <- insects$X
insects <- select(insects, -X)
plot(specaccum(insects), xlab = "# of samples", ylab = "# of species")
```

```{r, bees only}

insects <- read.csv("Output Data/wide_yesbeetle.csv")
bees <- select(insects, 5:7,12,14,16,36,37,42,43,49,50,61,64,65,67,72,73,75,87,92,96)


metadata <- read.csv("Clean Data/pantraps_cov.csv", header = TRUE)
metadata <- filter(metadata, species != "buckhorn")
metadata$plant.id <- as.character(metadata$plant.id)
str(metadata)
metadata$uniID <- paste(metadata$date, metadata$plant.id, metadata$treatment)
row.names(metadata) <- metadata$uniID


beemeta <- metadata

beemeta$abun <- apply(bees, 1, sum)
#check for total
sum(beemeta$abun)
H <- diversity(bees)
simp <- diversity(bees, "simpson")
S <- specnumber(bees)
J <- H/log(S)
beemeta$H <- H
beemeta$Simpson <- simp
beemeta$Species <- S
beemeta$Even <- J


t.test(beemeta$Species ~ beemeta$blooming)
beemeta$repID <- paste(beemeta$plant.id, beemeta$treatment)
library(glmmTMB)
m1 <- glmmTMB(Species ~ treatment + blooming + (1|plant.id/repID), family = "nbinom2", beemeta)
summary(m1)

car::Anova(m1, type = 2)
m2 <- glmmTMB(Species ~ treatment + blooming + (1|plant.id/repID), family = "poisson", beemeta)

summary(m2)
m3 <- glmmTMB(Species ~ treatment * blooming + (1|plant.id/repID), family = "poisson", beemeta)

null <- glmmTMB(Species ~  (1|plant.id/repID), family = "poisson", beemeta)

#poisson is best
AIC(m1, m2, m3, null)
#null model has lowest AIC
car::Anova(m2, type = 2)


#bee abundance

m1 <- glmmTMB(abun ~ treatment + blooming + (1|plant.id/repID), family = "nbinom2", beemeta)
summary(m1)

car::Anova(m1, type = 2)
m2 <- glmmTMB(abun ~ treatment + blooming + (1|plant.id/repID), family = "poisson", beemeta)

summary(m2)
m3 <- glmmTMB(abun ~ treatment * blooming + (1|plant.id/repID), family = "poisson", beemeta)

null <- glmmTMB(abun ~  (1|plant.id/repID), family = "poisson", beemeta)

#poisson is best
AIC(m1, m2, m3, null)
#null model has lowest AIC
car::Anova(m2, type = 2)
```


###Visitation to L. tridentata
In-situ observation of visitation to L. tridentata, to determine which pollinators were visiting and if visitation was related to flower number and/or height

```{r, larrea visitation}
larrea <- read.csv("Clean Data/larreavisits.csv")
cov <- read.csv("Clean Data/insitu_cov_larrea.csv")
sizes <- read.csv("Clean Data/video_larreadimensions.csv")
cov <- distinct(cov)
cov <- select(cov, -date)
cov$repID <- paste(cov$plant.id, "post")

larrea$repID <- paste(larrea$PlantID, larrea$pre.post)
cov <- inner_join(cov, sizes, by = "plant.id")
cov <- select(cov, -plant.id)
larrea <- left_join(larrea, cov, by = "repID")

#N.FLOWER is only applicable to post. it was just easier to join this way!

count(larrea, pre.post)

#how does floral visitation relate to #flowers
fl <- filter(larrea, part.used == "flower")
fl.count <- fl %>% count(repID)

lar.all <- left_join(cov, fl.count, by = "repID")

#there are 58 because of the wind 

#attach neighbour density
pans <- read.csv("Output Data/metadata_yesbeetle.csv")
pans$repID <- paste(pans$plant.id, pans$blooming)
pans <- filter(pans, blooming == "post" & treatment == "shrub")
lar.all <- left_join(lar.all, pans, by = "repID")

lar.all$n[is.na(lar.all$n)] <- 0

#join video covariates
vid.cov <- read.csv("Clean Data/video_cov.csv")
vid.cov$flowering <- gsub("bloom", "post", vid.cov$flowering)
vid.cov$repID <- paste(vid.cov$PlantID, vid.cov$flowering)
lar.all <- vid.cov %>% filter(flowering == "post" & treatment == "shrub") %>% left_join(lar.all, vid.cov, by = "repID")

ggplot(lar.all, aes(n)) + geom_density()

visitors <- fl %>% group_by(., pre.post, part.used) %>% count(., v.species)
sum(visitors$n)

#modelling
cov <- left_join(cov, fl.count, by = "repID")
cov$n[is.na(cov$n)] <- 0

m1 <- glm(data = cov, family = "quasipoisson"(link="log"), n ~ n.flowers)

summary(m1)
car::Anova(m1)
m2 <- glm(data = cov, family = "quasipoisson"(link="log"), n ~ n.flowers + height)
m3 <- glm(data = cov, family = "quasipoisson"(link="log"), n ~ height)

summary(m2)
summary(m3)
car::Anova(m3, type = 2)

ggplot(cov, aes(n.flowers, n)) + geom_point(shape = 1) + geom_smooth(color = "black", size = 0.5) + theme_Publication() + xlab("Floral abundance") + ylab("Visits per 15 min")

#cor.test(repcounts.all$n.flowers, repcounts.all$width)
cor.test(lar.all$n.flowers, lar.all$height)
#cor.test(repcounts.all$width, repcounts.all$height)

mean(lar.all$height)
```
***

# Abiotic effects
16 data loggers were placed in shrub/open microsites (8 and 8).
```{r, data loggers, warning = F}
setwd("Clean Data/loggers")
temp <- list.files(pattern="*.csv")
name <- list.files(pattern="*.csv")
datalist <- list()
for (i in 1:length(temp)) {
  ob <- read.csv(temp[i], header = FALSE)    #read in csv
  ob <- ob[-1,] #delete weird first row
  #colnames(ob) <- as.character(unlist(ob[1,]))
  ob <- ob[-1,]

  ob$loggername <- name[i]
  datalist[[i]] <- ob
}

allLoggers <- bind_rows(datalist)
colnames(allLoggers) <- c("1", "date.time", "temp", "light.intensity", "coupler.detached", "coupler.attached", "host.connected", "stopped", "logger.name", "end.of.file", "empty col")

#now for some wrangling
# split day and time column

 
allLoggers <- dplyr::select(allLoggers, -11)  
allLoggers <- separate(allLoggers, date.time, c("Date", "time"), sep = 9) %>% dplyr::select(-1) %>% separate("logger.name", c("plant.id", "treatment", sep = "-")) %>% dplyr::select(Date:light.intensity, plant.id:treatment) %>% separate(plant.id, c("species", "id"), sep = 1)

#delete rows from first days and last days
#delete rows from last day

allLoggers$Date <- gsub(" ","", allLoggers$Date)
allLoggers <- filter(allLoggers, Date != "05/11/17" & Date != "03/17/17" & Date != "03/18/17") 
allLoggers <- filter(allLoggers, Date != "") 
                     
#convert time from 12 to 24 hours
allLoggers$time <- format(strptime(allLoggers$time, "%I:%M:%S %p"), format="%H:%M:%S")

allLoggers$hour <- substr(allLoggers$time,1,2)
allLoggers$temp <- as.numeric(allLoggers$temp)
#EDA

str(allLoggers)


#larrea only

larrea <- filter(allLoggers, species == "L")
dailymax <- larrea %>% group_by(treatment, Date, id) %>% summarise(maxTemp = max(temp))
ggplot(data = dailymax, aes(Date, maxTemp, color = treatment)) + geom_point() 


dailymin <- larrea %>% group_by(treatment, Date, id) %>% summarise(minTemp = min(temp))
ggplot(data = dailymin, aes(Date, minTemp, color = treatment)) + geom_point() 

larrea$temp <- as.numeric(larrea$temp)
larrea$hour <- as.numeric(larrea$hour)
daytime <- filter(larrea, hour >= 9 & hour<21)
daytime <- na.omit(daytime)
nighttime <- filter(larrea, hour >=21 | hour<9)
nighttime <-na.omit(nighttime)
all <- larrea %>% group_by(treatment, Date, id) %>% summarise(meanTemp = mean(temp), varTemp = sd(temp))


meanday <- daytime %>% group_by(treatment, Date, id) %>% summarise(meanTemp = mean(temp), varTemp = sd(temp))

meannight<- nighttime %>% group_by(treatment, Date, id) %>% summarise(meanTemp = mean(temp), varTemp = sd(temp))

str(larrea)

larrea$hour <- as.factor(larrea$hour)

#figure for all
ggplot(data = larrea, aes(hour, ((temp-32)*0.5556))) + geom_boxplot(aes(fill = treatment)) + theme_Publication() + xlab("Hour") + ylab("Temperature in °C") + scale_fill_manual(values=c("#AF955A", "darkgreen"), name = "Microsite")

meannight$treatment <- as.factor(meannight$treatment)
kruskal.test(meannight$meanTemp ~ meannight$treatment)

ggplot(meannight, aes(meanTemp, fill = treatment)) + geom_density()       

#mean nightime temps
meannight$id <- as.factor(meannight$id)
m1 <- glmmTMB(meanTemp ~ treatment + (1|id), family = Gamma(link = "log"), data = meannight)
shapiro.test(resid(m1))
summary(m1)
car::Anova(m1, type =2)

#mean daytime temps
m2 <- glmmTMB(meanTemp ~ treatment + (1|id), family = Gamma(link = "log"), data = meanday)
summary(m2)
car::Anova(m2, type =2)


meanAll <- rbind(meanday, meannight)

#overal temperature variation
m3 <- glmmTMB(varTemp ~ treatment + (1|id), family = Gamma(link = "log"), data = all)
summary(m3)
car::Anova(m3, type = 2)


```

# RII
This code bootstraps 95% confidence intervals. Adapted from code written by Dr. Alex Filazzola https://github.com/afilazzola/CommEcolFunctions

```{r, RII, warning = F}

rii.m <- function(x, j, var)
{
  #parse out shrub and open
  s1 <- subset(x, treatment == "shrub", select=var)
  o1 <- subset(x, treatment == "open", select=var)
  return1 <- (s1 - o1) / (s1+o1)  # Rii formula
  # attach factors
  x1 <- x[seq(1, nrow(x), by = 2),]
  return2 <- cbind(x1[j], return1)
  return2[is.na(return2)] <- 0
  print(return2)
}

rii.b <- function(x, j, var)
{
  #parse out shrub and open
  s1 <- subset(x, flowering == "bloom", select=var)
  o1 <- subset(x, flowering == "pre", select=var)
  return1 <- (s1 - o1) / (s1+o1)  # Rii formula
  # attach factors
  x1 <- x[seq(1, nrow(x), by = 2),]
  return2 <- cbind(x1[j], return1)
  return2[is.na(return2)] <- 0
  print(return2)
}
bootmean <- function(d, i) mean(d[i])

byrep <- read.csv("Output Data/byrep_cleaned.csv")
metadata <- read.csv("Output Data/metadata_nobeetle.csv")
yesbeetle <- read.csv("Output Data/metadata_yesbeetle.csv")
pre <- filter(byrep, flowering == "pre")
pre <- dplyr::select(pre, Date, mean.Solar, mean.Wind, mean.Temp, PlantID, treatment, flowering, understory.richness, visits.per.hour, flowers.per.hour)

#split into 2 dataframes, rename the visitation columns and then rbind
#need to match up microsites
#there are 2 unmatched reps
pre <- arrange(pre, PlantID)
pre <- filter(pre, PlantID != 266 & PlantID != 275 & PlantID != 276 & PlantID != 196)

post <- filter(byrep, flowering =="bloom")
post <- dplyr::select(post, Date, mean.Solar, mean.Wind, mean.Temp, PlantID, treatment, flowering, understory.richness, visits.per.hour, flowers.per.hour)
post <- arrange(post, PlantID)
post <- filter(post, PlantID != 198)
post <- distinct(post)

pre.visits <- rii.m(pre, c(1:7), 8:10)
post.visits <- rii.m(post, c(1:7), 8:10)

t.test(post.visits$flowers.per.hour)

rii.visits.micro <- rbind(pre.visits, post.visits)

#from melyridae excluded pan traps

prepan <- filter(metadata, blooming == "pre")
prepan <- dplyr::select(prepan, date, mean.Solar, mean.Wind, mean.Temp, plant.id, treatment, blooming, abun, percent.cover)
#split into 2 dataframes, rename the visitation columns and then rbind
#there are 2 unmatched reps
prepan <- arrange(prepan, plant.id)

#prepan <- filter(prepan, plant.id != 266 & plant.id != 275 & plant.id != 276 & plant.id != 196)

pre.pan <- rii.m(prepan, c(1:7), 8:9)

postpan <- filter(metadata, blooming =="post")
postpan <- dplyr::select(postpan, date, mean.Solar, mean.Wind, mean.Temp, plant.id, treatment, blooming, abun, percent.cover)
postpan <- arrange(postpan, plant.id)

post.pan <- rii.m(postpan, c(1:7), 8:9)

rii.pan.micro <- rbind(pre.pan, post.pan)


pre.beetle <- filter(yesbeetle, blooming == "pre")
pre.beetle <- dplyr::select(pre.beetle, date, mean.Solar, mean.Wind, mean.Temp, plant.id, treatment, blooming, Species)

pre.beetle <- arrange(pre.beetle, plant.id)

#prepan <- filter(prepan, plant.id != 266 & plant.id != 275 & plant.id != 276 & plant.id != 196)
pre.beetle <- rii.m(pre.beetle, c(1:7), 8)

post.beetle <- filter(yesbeetle, blooming == "post")
post.beetle <- dplyr::select(post.beetle, date, mean.Solar, mean.Wind, mean.Temp, plant.id, treatment, blooming, Species)

post.beetle <- arrange(post.beetle, plant.id)

#prepan <- filter(prepan, plant.id != 266 & plant.id != 275 & plant.id != 276 & plant.id != 196)
post.beetle <- rii.m(post.beetle, c(1:7), 8)

rii.arth.richness.micro <- rbind(pre.beetle, post.beetle)

#bootstrapping means and CI for microsite RII

flowers.rii <- boot(rii.visits.micro$flowers.per.hour, bootmean, R=10000, stype ="i")
ci.flowers <- boot.ci(flowers.rii)
normal.flowers <- ci.flowers$normal



#annual richness
richness.rii <- boot(rii.visits.micro$understory.richness, bootmean, R=10000, stype ="i")
ci.richness <- boot.ci(richness.rii)
normal.richness <- ci.richness$normal

#percent cover
percent.cover.rii <- boot(rii.pan.micro$percent.cover, bootmean, R=10000, stype ="i")
ci.percent.cover <- boot.ci(percent.cover.rii)
normal.percent.cover <- ci.percent.cover$normal

#arthropod abundance
abun.rii <- boot(rii.pan.micro$abun, bootmean, R=10000, stype ="i")
ci.abun <- boot.ci(abun.rii)
normal.abun <- ci.abun$normal

#arthropod richness
arth.rich.rii <- boot(rii.arth.richness.micro$Species, bootmean, R=10000, stype ="i")
ci.arth.rich <- boot.ci(arth.rich.rii)
normal.arth.rich <- ci.arth.rich$normal

#OK bloom effects split by microsites

byrep <- read.csv("Output Data/byrep_cleaned.csv")

shrub <- filter(byrep, treatment == "shrub")
shrub <- dplyr::select(shrub, Date, mean.Solar, mean.Wind, mean.Temp, PlantID, treatment, flowering, understory.richness, visits.per.hour, flowers.per.hour)

#split into 2 dataframes, rename the visitation columns and then rbind
#need to match up microsites
#there are 2 unmatched reps
shrub <- arrange(shrub, PlantID)

shrub <- filter(shrub, PlantID != 196 & PlantID != "new1" & PlantID != 303 & PlantID != 299 & PlantID !=199) 
shrub <- subset(shrub[-43,])

#all matched

open <- filter(byrep, treatment == "open") 
open <- dplyr::select(open, Date, mean.Solar, mean.Wind, mean.Temp, PlantID, treatment, flowering, understory.richness, visits.per.hour, flowers.per.hour)
open <- arrange(open, PlantID) 
open <- filter(open, PlantID != 266 & PlantID != "new1" & PlantID != 303 & PlantID != 299 & PlantID != 275 & PlantID != 276) 

rii.shrub.visits <- rii.b(shrub, c(1:7), 8:10)
rii.open.visits <- rii.b(open, c(1:7), 8:10)

metadata <- read.csv("Output Data/metadata_nobeetle.csv")
metadata <- rename(metadata, flowering = blooming)
metadata$flowering <- gsub("post", "bloom", metadata$flowering)
shrubpan <- filter(metadata, treatment == "shrub")
shrubpan <- dplyr::select(shrubpan, date, mean.Solar, mean.Wind, mean.Temp, plant.id, treatment, flowering, abun, percent.cover)
#split into 2 dataframes, rename the visitation columns and then rbind

shrubpan <- arrange(shrubpan, plant.id)

shrubpan <- filter(shrubpan, plant.id != 104 & plant.id != 114 & plant.id != 182 & plant.id != 263 & plant.id != 287 & plant.id != 299 & plant.id != 301 & plant.id != 302 & plant.id != 303 & plant.id != 261)
 

rii.shrubpan <- rii.b(shrubpan, c(1:7), 8:9)

openpan <- filter(metadata, treatment =="open")
openpan <- dplyr::select(openpan, date, mean.Solar, mean.Wind, mean.Temp, plant.id, treatment, flowering, abun, percent.cover)
openpan <- arrange(openpan, plant.id)

openpan <- filter(openpan, plant.id != 104 & plant.id != 114 & plant.id != 182 & plant.id != 263 & plant.id != 287 & plant.id != 299 & plant.id != 301 & plant.id != 302 & plant.id != 303 & plant.id != 261)

rii.openpan <- rii.b(openpan, c(1:7), 8:9)


#arthropod richness, needs beetle dataset
yesbeetle <- read.csv("Output Data/metadata_yesbeetle.csv")
yesbeetle <- rename(yesbeetle, flowering = blooming)
yesbeetle$flowering <- gsub("post", "bloom", yesbeetle$flowering)
shrubrich <- filter(yesbeetle, treatment == "shrub")
shrubrich <- dplyr::select(shrubrich, date, mean.Solar, mean.Wind, mean.Temp, plant.id, treatment, flowering, Species)
#split into 2 dataframes, rename the visitation columns and then rbind

shrubrich<- arrange(shrubrich, plant.id)

shrubrich <- filter(shrubrich, plant.id != 104 & plant.id != 114 & plant.id != 182 & plant.id != 263 & plant.id != 287 & plant.id != 299 & plant.id != 301 & plant.id != 302 & plant.id != 303 & plant.id != 261)
 

rii.shrubrich <- rii.b(shrubrich, c(1:7), 8)
openrich <- filter(yesbeetle, treatment =="open")
openrich <- dplyr::select(openrich, date, mean.Solar, mean.Wind, mean.Temp, plant.id, treatment, flowering, Species)
openrich <- arrange(openrich, plant.id)

openrich <- filter(openrich, plant.id != 104 & plant.id != 114 & plant.id != 182 & plant.id != 263 & plant.id != 287 & plant.id != 299 & plant.id != 301 & plant.id != 302 & plant.id != 303 & plant.id != 261)

rii.openrich <- rii.b(openrich, c(1:7), 8)

#floral visitation
#shrubs
flowers.shrub.rii <- boot(rii.shrub.visits$flowers.per.hour, bootmean, R=10000, stype ="i")
ci.flowers.shrub <- boot.ci(flowers.shrub.rii)
normal.flowers.shrub <- ci.flowers.shrub$normal

#open
flowers.open.rii <- boot(rii.open.visits$flowers.per.hour, bootmean, R=10000, stype ="i")
ci.flowers.open <- boot.ci(flowers.open.rii)
normal.flowers.open <- ci.flowers.open$normal


#annual understory richness

understory.richness.shrub.rii <- boot(rii.shrub.visits$understory.richness, bootmean, R=10000, stype ="i")
ci.understory.richness.shrub <- boot.ci(understory.richness.shrub.rii)
normal.understory.richness.shrub <- ci.understory.richness.shrub$normal

#open
understory.richness.open.rii <- boot(rii.open.visits$understory.richness, bootmean, R=10000, stype ="i")
ci.understory.richness.open <- boot.ci(understory.richness.open.rii)
normal.understory.richness.open <- ci.understory.richness.open$normal


#annual percent cover
percent.shrub.rii <- boot(rii.shrubpan$percent.cover, bootmean, R=10000, stype ="i")
ci.percent.shrub <- boot.ci(percent.shrub.rii)
normal.percent.shrub <- ci.percent.shrub$normal

#open
percent.open.rii <- boot(rii.openpan$percent.cover, bootmean, R=10000, stype ="i")
ci.percent.open <- boot.ci(percent.open.rii)
normal.percent.open <- ci.percent.open$normal


#arthropd abundance
abun.shrub.rii <- boot(rii.shrubpan$abun, bootmean, R=10000, stype ="i")
ci.abun.shrub <- boot.ci(abun.shrub.rii)
normal.abun.shrub <- ci.abun.shrub$normal

#open
abun.open.rii <- boot(rii.openpan$abun, bootmean, R=10000, stype ="i")
ci.abun.open <- boot.ci(abun.open.rii)
normal.abun.open <- ci.abun.open$normal



#arthropod richness
Species.shrub.rii <- boot(rii.shrubrich$Species, bootmean, R=10000, stype ="i")
ci.Species.shrub <- boot.ci(Species.shrub.rii)
normal.Species.shrub <- ci.Species.shrub$normal

Species.open.rii <- boot(rii.openrich$Species, bootmean, R=10000, stype ="i")
ci.Species.open <- boot.ci(Species.open.rii)
normal.Species.open <- ci.Species.open$normal


```

```{r, RII figures}
means.all <- rbind(flowers.rii$t0, percent.cover.rii$t0, richness.rii$t0, abun.rii$t0, arth.rich.rii$t0, flowers.shrub.rii$t0, flowers.open.rii$t0, percent.shrub.rii$t0, percent.open.rii$t0, understory.richness.shrub.rii$t0, understory.richness.open.rii$t0, abun.shrub.rii$t0, abun.open.rii$t0, Species.shrub.rii$t0, Species.open.rii$t0)


colnames(means.all) <- c("means")

ci.all <- rbind(normal.flowers, normal.percent.cover, normal.richness, normal.abun, normal.arth.rich, normal.flowers.shrub, normal.flowers.open, normal.percent.shrub, normal.percent.open, normal.understory.richness.shrub, normal.understory.richness.open, normal.abun.shrub, normal.abun.open, normal.Species.shrub, normal.Species.open)


all.new <- cbind(means.all, ci.all)
all.new <- as.data.frame(all.new)

all.new$id <- c("microsite", "microsite", "microsite", "microsite", "microsite", "shrub", "open", "shrub", "open","shrub", "open","shrub", "open","shrub", "open")
                
all.new$metric <- c("visits", "percent.cover", "annual.richness", "arth.abundance" , "arth.richness", "visits", "visits", "percent.cover", "percent.cover", "annual.richness", "annual.richness", "arth.abundance", "arth.abundance", "arth.richness", "arth.richness")


all.new$metric <- as.factor(all.new$metric)
all.new$id <- as.factor(all.new$id)


all.new$metric <- factor(all.new$metric, levels = c("arth.richness", "arth.abundance", "annual.richness", "percent.cover", "visits"))
                         

metrics <- rev(c("Pollinator floral \n visitation per hour", "Annual \n Percent Cover", "Annual Species \n Richness", "Arthropod \n Abundance", "Arthropod \n Richness"))

#write.csv(all.boot, "Output Data/allboot.csv")
#write.csv(all.new, "Output Data/allnewboot.csv")


ggplot(all.new, aes(x=metric, y=means)) + geom_errorbar(aes(ymin=V3, ymax=V4, fill = id), width=.1, position= position_dodge(width = 0.5))+ geom_line(aes(fill = id),position=position_dodge(width=0.5)) + geom_point(aes(fill = id), position=position_dodge(width=0.5), colour="black",pch=21, size=5) + ylim(1, -1) + theme(axis.text.x=element_text(angle=90, vjust=.5)) + ylab("RII") + xlab("") + geom_hline(aes(yintercept=0)) + theme_Publication() + coord_flip() + scale_x_discrete(limits=levels(all.new$metric), labels = metrics)+ scale_fill_manual("",values = c("black", "lightgray", "white"), labels = c("Microsite: \n Shrub vs. Open", "Bloom period: \n Open", "Bloom period: \n Shrub"))  



#theme(legend.position = c(0.8, 0.1))  + ylab("RII Microsite") + theme(axis.title.x = element_text(size =11)) + guides(fill = guide_legend(nrow = 2, byrow = TRUE)) 



```

```{r, calcs}
sizes <- read.csv("Clean Data/video_larreadimensions.csv")
sizes$PlantID <- sizes$plant.id
mean(sizes$width)

h <- left_join(byrep, sizes, by = "PlantID")
h <- filter(h, treatment == "shrub" & flowering == "pre")
mean(h$width, na.rm = TRUE)
sd(h$width, na.rm = TRUE)

mean(h$height, na.rm = TRUE)
sd(h$height, na.rm = TRUE)
```


## Figures
```{r, warning = FALSE}
data <- read.csv("Output Data/rtu_by_rep.csv")
summary <- data %>% group_by(rtu, treatment, flowering) %>% summarise(mean.visits = mean(visits.per.hour), se.visits = se(visits.per.hour), mean.flowers = mean(flowers.per.hour), se.flowers = se(flowers.per.hour))

summary$t <- paste(summary$treatment, summary$flowering)
summary$t <- as.factor(summary$t)
summary$t <- factor(summary$t, levels = c("shrub pre", "open pre", "shrub bloom", "open bloom"))

summary$flowering <- relevel(summary$flowering, "pre")
labels <- c(pre = "Pre-blooming", post = "Blooming", bloom = "Blooming")


ggplot(summary, aes(rtu, mean.visits, group = t)) + geom_bar(aes (fill = t), stat = "identity", position = "dodge", color = "black") + geom_errorbar(aes(ymin = mean.visits - se.visits, ymax = mean.visits + se.visits), width = 0.2, position = position_dodge(0.9)) + theme_Publication()  + ylab("Mean foraging bouts/hr ") + scale_x_discrete(labels = c("Solitary Bee", "Bombyliidae", "Honeybee", "Lepidoptera", "Other", "Syrphidae")) + theme(axis.text.x = element_text(angle = 90, vjust = 0.2), axis.title.y = element_text(size = 12)) + scale_fill_manual("", values = c("shrub pre" ="black", "open pre"= "white", "shrub bloom"= "black", "open bloom"= "white")) + theme(legend.position = "none", legend.title = element_blank(),axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank()) + xlab("") + facet_grid(~flowering, labeller=labeller(flowering = labels)) 

ggplot(summary, aes(rtu, mean.flowers, group = t)) + geom_bar(aes (fill = t), stat = "identity", position = "dodge", color = "black") + geom_errorbar(aes(ymin = mean.flowers - se.flowers, ymax = mean.flowers + se.flowers), width = 0.2, position = position_dodge(0.9)) + theme_Publication() + ylab("Mean flowers visited/hr") + scale_x_discrete(labels = c("Solitary bees", "Bee flies", "Honeybees", "Butterflies and \n sphinx moths", "Other", "Hoverflies")) + theme(axis.text.x = element_text(angle = 90, vjust = 0.2, hjust = 1), axis.title.y = element_text(size = 12)) + scale_fill_manual("", values = c("shrub pre" ="black", "open pre"= "white", "shrub bloom"= "black", "open bloom"= "white")) + xlab("") + facet_grid(~flowering) + theme(strip.background = element_blank(), strip.text = element_blank()) + theme(legend.position = "none")



#figure2
data <- read.csv("Output Data/rtu_by_rep.csv")
summary2 <- byrep %>% group_by(treatment, flowering) %>% summarise(mean.visits = mean(visits.per.hour), se.visits = se(visits.per.hour), mean.flowers = mean(flowers.per.hour), se.flowers = se(flowers.per.hour))


summary2$t <- paste(summary2$treatment, summary2$flowering)

summary2$t <- as.factor(summary2$t)

summary2$t <- factor(summary2$t, levels = c("shrub pre", "open pre", "shrub bloom", "open bloom"))

summary2$flowering <- relevel(summary2$flowering, "pre")
summary2$treatment <- relevel(summary2$treatment, "shrub")
labels <- c(pre = "Pre-blooming", post = "Full Bloom", bloom = "Full Bloom")


ggplot(summary2, aes(treatment, mean.visits)) + geom_bar(aes (fill = treatment), stat = "identity", position = "dodge", color = "black") + geom_errorbar(aes(ymin = mean.visits - se.visits, ymax = mean.visits + se.visits), width = 0.2, position = position_dodge(0.9)) + theme_Publication()  + ylab("Mean foraging bouts/hr ") + theme(axis.text.x = element_text(angle = 90, vjust = 0.2, hjust = 1), axis.title.y = element_text(size = 12)) + scale_fill_manual("", values = c("shrub" ="black", "open"= "white")) + theme(legend.position = "none", legend.title = element_blank(),axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank()) + xlab("") + facet_grid(~flowering, labeller=labeller(flowering = labels))


ggplot(summary2, aes(treatment, mean.flowers)) + geom_bar(aes (fill = treatment), stat = "identity", position = "dodge", color = "black") + geom_errorbar(aes(ymin = mean.flowers - se.flowers, ymax = mean.flowers + se.flowers), width = 0.2, position = position_dodge(0.9)) + theme_Publication()  + ylab("Mean flowers visited/hr ") + theme(axis.text.x = element_text(angle = 90, vjust = 0.2, hjust = 1), axis.title.y = element_text(size = 12)) + scale_fill_manual("", values = c("shrub" ="black", "open"= "white")) + theme(legend.position = "none", legend.title = element_blank(),axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank()) + xlab("") + facet_grid(~flowering)  + theme(strip.background = element_blank(), strip.text = element_blank()) + theme(legend.position = "none")


se <- function(x) sd(x, na.rm = T)/sqrt(length(x)) ## SE

summary3 <- rtu.data %>% group_by(microsite, flowering) %>% summarise(mean.duration = mean(dec.total.time, na.rm = T), se.duration = se(dec.total.time))

summary3$microsite <- relevel(summary3$microsite, "shrub")

summary3$t <- paste(summary3$microsite, summary3$flowering)


summary3$t <- as.factor(summary3$t)
summary3$t <- factor(summary3$t, levels = c("shrub pre", "open pre", "shrub bloom", "open bloom"))


ggplot(summary3, aes(microsite, mean.duration*60)) + geom_bar(aes (fill = microsite), stat = "identity", position = "dodge", color = "black") + geom_errorbar(aes(ymin = mean.duration*60 - se.duration*60, ymax = mean.duration*60 + se.duration*60), width = 0.2, position = position_dodge(0.9)) + theme_Publication()  + ylab("Mean visit duration (min)") + theme(axis.text.x = element_text(angle = 90, vjust = 0.2, hjust = 1), axis.title.y = element_text(size = 12)) + scale_fill_manual("", values = c("shrub" ="black", "open"= "white")) + theme(axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank()) + xlab("") + facet_grid(~flowering)  + theme(strip.background = element_blank(), strip.text = element_blank())









```



```{r}

visits <- read.csv("Output Data/byrep_cleaned.csv")
metadata <- read.csv("Output Data/metadata_nobeetle.csv")
nobeetle <- read.csv("Output Data/metadata_nobeetle.csv")
incbeetle <- read.csv("Output Data/metadata_yesbeetle.csv")
onlybeetle <- read.csv("Output Data/metadata_onlybeetle.csv")

labels <- c(pre = "Pre-blooming", post = "Full bloom", bloom = "Full Bloom")
visits$flowering <- relevel(visits$flowering, "pre")
metadata$blooming <- relevel(metadata$blooming, "pre")
metadata$treatment <- relevel(metadata$treatment, "shrub")
visits$treatment <- relevel(visits$treatment, "shrub")
incbeetle$treatment <- relevel(incbeetle$treatment, "shrub")
incbeetle$blooming <- relevel(incbeetle$blooming, "pre")
onlybeetle$blooming <- relevel(onlybeetle$blooming, "pre")
byrtu$flowering <- relevel(byrtu$flowering, "pre")

a <- ggplot(metadata, aes(treatment, percent.cover)) + 
  stat_boxplot(geom ='errorbar', width = 0.2) + geom_boxplot(aes(fill = treatment)) + theme_Publication() + ggtitle("Percent Annual Cover") + ylab("") + xlab("") + facet_grid(~blooming,labeller=labeller(blooming = labels))  +theme(plot.title = element_text(size = (10)))+ facet_grid(~blooming,labeller=labeller(blooming = labels)) + scale_fill_manual("", values = c("shrub" ="black", "open"= "white")) + theme(legend.position = "none") + stat_summary(fun=mean, colour="red", geom="point", shape=18, size=3,show.legend = FALSE) + theme(plot.margin=unit(c(1,0.1,0,1), "cm"), axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank())
a
b <- ggplot(visits, aes(treatment, understory.richness)) + 
  stat_boxplot(geom ='errorbar', width = 0.2) + geom_boxplot(aes(fill = treatment)) + theme_Publication() + ggtitle("Annual Richness") + ylab("") + xlab("")  +theme(plot.title = element_text(size = (10)))+ facet_grid(~flowering,labeller=labeller(flowering = labels)) + scale_fill_manual("", values = c("shrub" ="black", "open"= "white")) + theme(legend.position = "none") + stat_summary(fun.y=mean, colour="red", geom="point", shape=18, size=3,show_guide = FALSE) + theme(plot.margin=unit(c(1,1,0,0.1), "cm"),axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank())

c <- ggplot(metadata, aes(treatment, abun)) + 
  stat_boxplot(geom ='errorbar', width = 0.2) + geom_boxplot(aes(fill = treatment)) + theme_Publication() + ggtitle("Arthropod Abundance") + ylab("") + xlab("") + facet_grid(~blooming,labeller=labeller(blooming = labels))  +theme(plot.title = element_text(size = (10)))+ facet_grid(~blooming,labeller=labeller(blooming = labels)) + scale_fill_manual("", values = c("shrub" ="black", "open"= "white")) + theme(legend.position = "none") + stat_summary(fun.y=mean, colour="red", geom="point", shape=18, size=3,show_guide = FALSE) + theme(strip.background = element_blank(), strip.text = element_blank()) + theme(plot.margin=unit(c(0.1,0.1,1,1), "cm"),axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank())


d <- ggplot(incbeetle, aes(treatment, Species)) + 
  stat_boxplot(geom ='errorbar', width = 0.2) + geom_boxplot(aes(fill = treatment)) + theme_Publication() + ggtitle("Arthropod Richness") + ylab("") + xlab("") + facet_grid(~blooming,labeller=labeller(blooming = labels))  +theme(plot.title = element_text(size = (10)))+ facet_grid(~blooming,labeller=labeller(blooming = labels)) + scale_fill_manual("", values = c("shrub" ="black", "open"= "white")) + theme(legend.position = "none") + stat_summary(fun.y=mean, colour="red", geom="point", shape=18, size=3,show_guide = FALSE) + theme(strip.background = element_blank(), strip.text = element_blank()) + theme(plot.margin=unit(c(0.1,1,1,0), "cm"),axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank())

library(cowplot)

cowplot::plot_grid(a,b,c,d)

```




