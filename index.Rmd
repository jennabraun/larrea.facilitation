---
title: "Chapter 2 Data and Statistics"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(lubridate)
library(tidyr)

source("Scripts/functions.R")
```

# Overview

Chapter 2 data wrangling, data visualization and statistics.

# Data wrangling and clean up
This section creates several .csv files that get used later for stats


### Video data clean up

```{r videos}
vids <- read.csv("Clean Data/videos_clean.csv")
IDlist <- read.csv("Clean Data/video_repID.csv")



str(vids)
#clear up incosistencies in capitalization and escape characters
vids$Rep <- gsub('\\s+', "", vids$Rep)
vids$microsite <- gsub('\\s+', "", vids$microsite)
vids$flowering <- gsub('\\s+', "", vids$flowering)
vids$flowering <-gsub("post", "bloom", vids$flowering)
vids$flowering <-gsub("Bloom", "bloom", vids$flowering)
vids$microsite <-gsub("Shrub", "shrub", vids$microsite)

#check for correc rep info
vids$id.check <- paste(vids$video.date, vids$plant.id, vids$Rep, vids$microsite, vids$flowering)
id.counts <- count(vids, id.check)
#it looks like 30 empty videos

#create unique identifier for replicates
#vids$flowers.visits <- as.numeric(vids$flowers.visits)
vids$uniID <- paste(vids$Rep, vids$video.date)
vids$uniID <- gsub('\\s+', "", vids$uniID)

#subset flower visits where insect flies on
flr <- filter(vids, flowers.visits != 0 & flies.on == "Y") 
#flr <- filter(vids, flowers.visits != 0) 
summary(flr)
str(flr)

#need time in a decimal format
#flr$unique.fl.visited <- as.numeric(flr$unique.fl.visited)
flr$pos.total.time <- as.POSIXct(strptime(flr$total.time, "%H:%M:%S"))
flr$dec.total.time <- (hour(flr$pos.total.time) * 3600 + minute(flr$pos.total.time) * 60 + second(flr$pos.total.time)) / 3600
flr <- mutate(flr, prop.fl.visited = flowers.visits/flower.fov, prop.un.fl.visited = unique.fl.visited/flower.fov)



#this data only contains observations, so need to include reps with zero visits

IDlist$uniID <- paste(IDlist$Rep, IDlist$Day)
IDlist$uniID <- gsub('\\s+', "", IDlist$uniID)

#exclude certain reps: too windy, battery failed etc
IDlist <- filter(IDlist, Exclude != "Y")

#count plant visits per rep
counts <- flr %>% group_by(uniID) %>% summarise(total.visits = n()) 

#count the total number of flowers visited per video
count.fl <- flr %>% group_by(uniID) %>% summarise(total.flowers = sum(flowers.visits)) 

#add reps with zero visits
zeros <- anti_join(IDlist, counts, by = "uniID")
all.data <- bind_rows(zeros, counts)
all.data <- dplyr::select(all.data, uniID, total.visits)

#replace NAs with zeros
all.data$total.visits[is.na(all.data$total.visits)] <- 0

#join video length
all.data <- IDlist %>% dplyr::select(Length, uniID) %>% right_join(all.data,., by = "uniID")

#join covariates
cov <- read.csv("Clean Data/video_cov.csv")
str(cov)
cov$uniID <- paste(cov$Cam, cov$Date)
cov$uniID <- gsub('\\s+', "", cov$uniID)
all.data <- right_join(cov, all.data, by = "uniID")


#convert to decimal time to standardize visits
all.data$pos.Length <- as.POSIXct(strptime(all.data$Length, "%H:%M:%S"))
all.data$dec.Length <- (hour(all.data$pos.Length) * 3600 + minute(all.data$pos.Length) * 60 + second(all.data$pos.Length)) / 3600


#plant visits per hour
all.data <- mutate(all.data, visits.per.hour = total.visits/dec.Length)

#number of flowers visited per hour
all.data <- left_join(all.data, count.fl, by = "uniID")
all.data$total.flowers[is.na(all.data$total.flowers)] <- 0
all.data <- mutate(all.data, flowers.per.hour = total.flowers/dec.Length)

#add weather data
weather <- read.csv("Clean Data/video_weather.csv")
weather.av <- weather %>% group_by(., Date) %>% summarise(., mean.Solar = mean(Solar), mean.Wind = mean(Wind), mean.MaxWind = mean(Max), mean.Temp = mean(Air.Temperature))
all.data <- right_join(weather.av, all.data, by = "Date")

#want to test out standardizing by visits/flower/hr
fov <- select(flr, uniID, flower.fov)
fov <- distinct(fov)
fov <- fov[-c(191,187),] #get rid of weird bit
all.data <- right_join(fov, all.data, by = "uniID")

#calculate per flower/per hour

all.data <- mutate(all.data, visits.flower.hr = total.visits/flower.fov/dec.Length)
all.data <- mutate(all.data, flowers.flower.hr = total.flowers/flower.fov/dec.Length)

#replace NA with zeros
all.data$visits.flower.hr[is.na(all.data$visits.flower.hr)] <- 0
all.data$flowers.flower.hr[is.na(all.data$flowers.flower.hr)] <- 0

#output data
write.csv(all.data, "byrep_cleaned.csv")
write.csv(flr, "byobs_cleaned.csv")


#visits by rtu
rtu.key <- read.csv("Clean Data/video_rtu_key.csv")
rtu.data <- left_join(rtu.key, flr, by = "highest.rtu")
rtu.data <- dplyr::select(rtu.data, rtu.ag, plant.id, microsite, flowering, video.date, video.length, flower.fov, total.time, flowers.visits, unique.fl.visited, uniID)                    
count.rtu.fl <- rtu.data %>% group_by(uniID, rtu.ag) %>% summarise(total.flowers = sum(flowers.visits), total.visits = n()) 

#add zero rows
#zeros.rtu <- anti_join(IDlist, count.rtu.fl, by = "uniID")
#all.rtu.data <- bind_rows(zeros.rtu, count.rtu.fl)
#all.rtu.data <- dplyr::select(all.rtu.data, uniID, rtu.ag, total.visits, total.flowers)

#need to add the zero count rtu somehow. gonna be messy 
#maybe if we spread, then fill in zeros, then gather back?
all.rtu.data <- count.rtu.fl
id <- as.data.frame(IDlist$uniID)
id$uniID <- id$`IDlist$uniID`
id <- dplyr::select(id, uniID)
id$syrphid <- 1
id$bee <- 2
id$other <- 3
id$bombylid <- 4
id$lep <- 5
id$honeybee <- 6
id <- gather(id, "rtu", "count", 2:7)
count(id, rtu)

id$join <- paste(id$uniID, id$rtu)
id$test <- 1
all.rtu.data$join <- paste(all.rtu.data$uniID, all.rtu.data$rtu.ag)

test <- dplyr::full_join(id, all.rtu.data, by = "join")

all.rtu <- dplyr::select(test, uniID.x, rtu, total.visits, total.flowers)
all.rtu$total.visits[is.na(all.rtu$total.visits)] <- 0
all.rtu$total.flowers[is.na(all.rtu$total.flowers)] <- 0

all.rtu <- dplyr::rename(all.rtu, uniID = uniID.x)

#join video length
all.rtu <- IDlist %>% dplyr::select(Length, uniID) %>% right_join(all.rtu,., by = "uniID")

#join covariates

all.rtu <- right_join(cov, all.rtu, by = "uniID")


#convert to decimal time to standardize visits
all.rtu$pos.Length <- as.POSIXct(strptime(all.rtu$Length, "%H:%M:%S"))
all.rtu$dec.Length <- (hour(all.rtu$pos.Length) * 3600 + minute(all.rtu$pos.Length) * 60 + second(all.rtu$pos.Length)) / 3600

#plant visits per hour
all.rtu <- mutate(all.rtu, visits.per.hour = total.visits/dec.Length)
all.rtu <- mutate(all.rtu, flowers.per.hour = total.flowers/dec.Length)

all.rtu <- dplyr::select(all.rtu, -SecondaryID, -Cam)

#output
write.csv(all.rtu, "rtu_by_rep.csv")
```

### Pan traps
```{r}
#data is in long format
#aggregrate counts by rep

long <- read.csv("Clean Data/pantraps_id.csv")
#sp.key <- read.csv("species_key.csv")
long$Microsite <- gsub(" ","", long$Microsite)
long$uniID <- paste(long$Date, long$PlantID, long$Microsite)
#long <- inner_join(long, sp.key, by = "highest.rtu")

#need to collapse & add up the Quantity
long.fil <- dplyr::select(long, uniID, highest.rtu, Quantity)
long.ag <- long.fil %>% group_by(uniID, highest.rtu) %>% summarise(Quantity = sum(Quantity)) 

write.csv(long.ag, "pantraps_long.csv")

wide <- long.ag %>% spread(highest.rtu, Quantity)
#wide$unknown <- wide$"?"
#wide <- dplyr::select(wide, -wide$"?")
wide[is.na(wide)] <- 0
write.csv(wide, "pantraps_wide.csv")
```
```






# Data visualization
Exploratory data analysis

### Video data viz

```{r video data viz}
byrep <- read.csv("byrep_cleaned.csv")
byobs <- read.csv("byobs_cleaned.csv")
byrtu <- read.csv("rtu_by_rep.csv")
str(byrep)


shapiro.test(byrep$visits.per.hour)
ggplot(data = byrep, aes(visits.per.hour)) + geom_freqpoly()

shapiro.test(byrep$total.visits)
ggplot(data = byrep, aes(total.visits)) + geom_freqpoly()

shapiro.test(byrep$flowers.per.hour)
ggplot(data = byrep, aes(flowers.per.hour)) + geom_freqpoly()

shapiro.test(byrep$total.flowers)
ggplot(data = byrep, aes(total.flowers)) + geom_freqpoly()


#length of flower visit
#need to join simplified rtu
rtu.key <- read.csv("Clean Data/video_rtu_key.csv")
rtu.data <- right_join(rtu.key, byobs, by = "highest.rtu")
times <- rtu.data %>% group_by(., microsite, flowering, rtu.ag) %>% summarise(mean(dec.total.time))
ggplot(rtu.data, aes(rtu.ag, dec.total.time)) + geom_boxplot() + facet_grid(microsite~flowering)
ggplot(byrtu, aes(rtu, visits.per.hour)) + geom_bar(stat = "identity") + facet_grid(flowering~treatment)
ggplot(byrtu, aes(rtu, flowers.per.hour)) + geom_bar(stat = "identity") + facet_grid(flowering~treatment)
ggplot(byrtu, aes(rtu, flowers.per.hour)) + geom_boxplot() + facet_grid(flowering~treatment)


```

# Stats and Models
### Visitation Models
```{r}
#replicate based analyses
byrep$repID <- paste(byrep$PlantID, byrep$treatment)
byrep$treatment <- relevel(byrep$treatment, "open")
byrep$flowering <- relevel(byrep$flowering, "pre")


```
### Vegetation 
```{r}

```
### Pan traps
```{r}

```

